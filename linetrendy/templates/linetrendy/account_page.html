{% extends 'linetrendy/base.html' %}
{% load static %}

{% block content %}
<section class="bg-gray-100 min-h-screen py-10">
  <div class="container mx-auto px-4">
    <h1 class="text-3xl md:text-4xl font-bold text-red-600 mb-8 text-center">My Account</h1>
    
    <div class="flex flex-col md:flex-row bg-white shadow-lg rounded-lg overflow-hidden">
      
      <!-- Sidebar Navigation -->
      <div class="md:w-1/4 bg-gray-50 border-r border-gray-200 p-6">
        <ul class="space-y-4">
          <li>
            <button onclick="showTab('orders')" 
                    class="w-full text-left font-medium text-gray-700 hover:text-red-600 transition-colors" 
                    id="tab-orders-btn">
              Orders
            </button>
          </li>
          <li>
            <button onclick="showTab('address')" 
                    class="w-full text-left font-medium text-gray-700 hover:text-red-600 transition-colors" 
                    id="tab-address-btn">
              Addresses
            </button>
          </li>
          <li>
            <button onclick="showTab('profile')" 
                    class="w-full text-left font-medium text-gray-700 hover:text-red-600 transition-colors" 
                    id="tab-profile-btn">
              Profile
            </button>
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="md:w-3/4 p-6">
        
        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Orders</h2>
          {% if orders %}
            <div class="space-y-4">
              {% for order in orders %}
              <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow bg-gray-50">
                <button type="button" class="w-full flex justify-between items-center text-left"
                        onclick="toggleOrder('{{ order.id }}')">
                  <div>
                    <span class="font-medium text-red-600">{{ order.product.name }}</span>
                    {% if order.status == "cancelled" %}
                      <span class="font-medium text-gray-600">Order #: {{ order.order_number }}</span>
                    {% else %}
                      <span class="font-medium text-red-600">Order #: {{ order.order_number }}</span>
                    {% endif %}
                  </div>
                  <div>
                    <span class="text-gray-700">{{ order.items.count }} item(s)</span>
                    <span class="ml-4 font-semibold text-gray-800">${{ order.total_amount|floatformat:2 }}</span>
                  </div>
                </button>

                <div id="order-{{ order.id }}" class="hidden mt-4 border-t pt-3 space-y-4">
                  <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-gray-500">Placed on: {{ order.created_at|date:"F d, Y" }}</p>
                    <p class="text-sm font-medium
                      {% if order.status == 'placed' %}text-yellow-600
                      {% elif order.status == 'shipped' %}text-blue-600
                      {% elif order.status == 'delivered' %}text-green-600
                      {% elif order.status == 'cancelled' or order.status == 'refunded' %}text-red-600
                      {% else %}text-gray-600{% endif %}">
                      {{ order.status|capfirst }}
                    </p>
                  </div>

                  {% for item in order.items.all %}
                  <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm">
                    <div class="w-16 h-16 mr-4">
                      {% if item.product %}
                        {% with item.product.get_first_image as first_image %}
                          {% if first_image %}
                            <img src="{{ first_image.image.url }}" alt="{{ item.product.name }}" class="w-16 h-16 object-cover rounded-md">
                          {% else %}
                            <img src="https://images.unsplash.com/photo-1571781926291-c477ebfd024b?auto=format&fit=crop&w=1888&q=80" 
                                alt="{{ item.product_name }}" class="w-16 h-16 object-cover rounded-md">
                          {% endif %}
                        {% endwith %}
                      {% else %}
                        <img src="https://images.unsplash.com/photo-1571781926291-c477ebfd024b?auto=format&fit=crop&w=1888&q=80" 
                            alt="{{ item.product_name }}" class="w-16 h-16 object-cover rounded-md">
                      {% endif %}
                    </div>
                    <div class="flex-1">
                      <p class="font-medium text-gray-800">{{ item.product.name }}</p>
                      <p class="text-sm text-gray-600">Qty: {{ item.quantity }}</p>
                    </div>
                    <div class="font-semibold text-gray-800">
                      ${{ item.price|floatformat:2 }}
                    </div>
                  </div>
                  {% endfor %}

                  <!-- Action Buttons -->
                  <div class="flex gap-2 mt-4">
                    {% if order.status != "cancelled" %}
                      <a href="{% url 'shop:order_tracking' order.order_number %}" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-full text-sm shadow transition flex items-center justify-center">
                        Track
                      </a>
                    {% endif %}

                    {% if order.status == "placed" %}
                      <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full text-sm"
                              onclick="openCancelModal('{{ order.order_number }}')">
                        Cancel
                      </button>

                    {% elif order.status != "cancelled" %}
                      <div class="relative group">
                        <button class="bg-gray-300 text-gray-600 py-1 px-3 rounded-full text-sm cursor-not-allowed flex items-center justify-center" disabled>Cancel</button>
                        <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-blue-800 text-white text-xs rounded-md p-2 w-64 text-center shadow-lg pointer-events-none z-50">
                          Cancellation Not Available: This order has already been shipped and cannot be canceled. 
                          You may initiate a return after delivery according to our return policy.
                        </div>
                      </div>

                    
                    {% endif %}
                  </div>

                  <!-- Shipping Address -->
                  {% if order.shipping_addresses.all %}
                      {% for address in order.shipping_addresses.all %}
                        <p class="font-semibold text-gray-800">Shipping Address:</p>
                      {% if user.is_authenticated %}
                        <p class="font-medium text-gray-800">{{ user.email }}</p>
                      {% endif %}
                      <p class="text-gray-700">{{ address.full_name }}</p>
                      <p class="text-gray-600">{{ address.line1 }}{% if address.line2 %}, {{ address.line2 }}{% endif %}</p>
                      <p class="text-gray-600">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                      <p class="text-gray-600">{{ address.country }}</p>
                      {% if address.phone %}
                      <p class="text-gray-600">{{ address.phone }}</p>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- Pagination -->
            {% if orders.has_other_pages %}
            <div class="mt-6 flex justify-center space-x-2 flex-wrap">
              {% if orders.has_previous %}
                <a href="?page={{ orders.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Previous</a>
              {% endif %}
              {% for num in orders.paginator.page_range %}
                {% if orders.number == num %}
                  <span class="px-3 py-1 bg-red-600 text-white rounded">{{ num }}</span>
                {% else %}
                  <a href="?page={{ num }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
                {% endif %}
              {% endfor %}
              {% if orders.has_next %}
                <a href="?page={{ orders.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>
              {% endif %}
            </div>
            {% endif %}
          {% else %}
            <p class="text-gray-600">You have no orders yet.</p>
          {% endif %}
        </div>

        <!-- My Address Tab (fixed layout) -->
        <div id="address-tab" class="tab-content hidden">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Addresses</h2>
          <div id="address-tab-wrapper">
            {% if addresses %}
              <div id="address-list" class="space-y-4">
                {% for address in addresses %}
                  <div 
                    class="border rounded-lg p-4 hover:shadow-lg transition-shadow bg-gray-50 flex justify-between items-start"
                    data-id="{{ address.id }}"
                    data-full_name="{{ address.full_name }}"
                    data-line1="{{ address.line1 }}"
                    data-line2="{{ address.line2 }}"
                    data-city="{{ address.city }}"
                    data-state="{{ address.state }}"
                    data-postal_code="{{ address.postal_code }}"
                    data-country="{{ address.country }}"
                    data-phone="{{ address.phone }}"
                  >
                    <div>
                      <p class="font-semibold text-gray-800">{{ address.full_name }}</p>
                      <p class="text-gray-600">{{ address.line1 }}{% if address.line2 %}, {{ address.line2 }}{% endif %}</p>
                      <p class="text-gray-600">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                      <p class="text-gray-600">{{ address.country }}</p>
                      <p class="text-gray-600">{{ address.phone }}</p>
                    </div>
                    <div class="flex flex-col gap-2 ml-4">
                      <button onclick="openEditAddressModal({{ address.id }})" 
                              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded transition">Edit</button>
                      <button onclick="openDeleteModal({{ address.id }})" 
                              class="bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded transition">Delete</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-gray-600">You haven't added any addresses yet.</p>
            {% endif %}

            <button onclick="openAddAddressModal()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition">
              Add New Address
            </button>
          </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Profile</h2>
            <form method="POST" class="space-y-4">
                {% csrf_token %}
                <!-- First & Last Name -->
                <div class="flex flex-col sm:flex-row sm:space-x-4">
                    <div class="flex-1">
                        <label class="block text-gray-700 mb-1">First Name</label>
                        <input type="text" name="first_name" value="{{ user.first_name }}"
                              class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                    <div class="flex-1 mt-4 sm:mt-0">
                        <label class="block text-gray-700 mb-1">Last Name</label>
                        <input type="text" name="last_name" value="{{ user.last_name }}"
                              class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                </div>

                <!-- Email & Phone -->
                <div>
                    <label class="block text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" value="{{ user.email }}" 
                          class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 mb-1">Phone</label>
                    <input type="text" name="phone" value="{{ user.profile.phone }}" 
                          class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-red-500 focus:outline-none">
                </div>

                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition">
                    Save Changes
                </button>
            </form>
        </div>

      </div>
    </div>
  </div>
</section>

<!-- Modals (unchanged) -->
<!-- Cancel Order Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Cancel Order</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to cancel this order?</p>
    <form id="cancelOrderForm" method="post">{% csrf_token %}
      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeCancelModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">No, Keep Order</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Yes, Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add/Edit/Delete Address Modals (unchanged) -->
<!-- Add Address Modal -->
<div id="add-address-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-lg relative">
    <h3 class="text-xl font-semibold mb-4">Add Address</h3>
    <form method="POST" 
      hx-post="{% url 'shop:update_address' %}" 
      hx-target="#address-tab-wrapper" 
      hx-swap="outerHTML"
      hx-on::after-request="closeAddAddressModal()">
      {% csrf_token %}
      <input type="hidden" name="address_id" value="">
      <input type="text" name="full_name" placeholder="Full Name" class="w-full mb-2 border rounded px-3 py-2">
      <input type="text" name="line1" placeholder="Street Address" class="w-full mb-2 border rounded px-3 py-2">
      <input type="text" name="line2" placeholder="Apartment / Suite (Optional)" class="w-full mb-2 border rounded px-3 py-2">
      <div class="flex gap-3">
        <input type="text" name="city" placeholder="City" class="w-1/2 mb-2 border rounded px-3 py-2">
        <input type="text" name="state" placeholder="State" class="w-1/2 mb-2 border rounded px-3 py-2">
      </div>
      <div class="flex gap-3">
        <input type="text" name="postal_code" placeholder="Postal Code" class="w-1/2 mb-2 border rounded px-3 py-2">
        <input type="text" name="country" placeholder="Country" class="w-1/2 mb-2 border rounded px-3 py-2">
      </div>
      <input type="text" name="phone" placeholder="Phone Number" class="w-full mb-4 border rounded px-3 py-2">
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeAddAddressModal()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Address Modal -->
<div id="edit-address-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-lg relative">
    <h3 class="text-xl font-semibold mb-4">Edit Address</h3>
    <form id="edit-address-form" 
          method="POST" 
          hx-post="{% url 'shop:update_address' %}" 
          hx-target="#address-tab-wrapper" 
          hx-swap="outerHTML"
          hx-on::after-request="closeEditAddressModal()">
      {% csrf_token %}
      <input type="hidden" name="address_id" id="edit_address_id">
      <input type="text" name="full_name" id="edit_full_name" class="w-full mb-2 border rounded px-3 py-2" placeholder="Full Name">
      <input type="text" name="line1" id="edit_line1" class="w-full mb-2 border rounded px-3 py-2" placeholder="Street Address">
      <input type="text" name="line2" id="edit_line2" class="w-full mb-2 border rounded px-3 py-2" placeholder="Apartment / Suite (Optional)">
      
      <div class="flex gap-3">
        <input type="text" name="city" id="edit_city" class="w-1/2 mb-2 border rounded px-3 py-2" placeholder="">
        <input type="text" name="state" id="edit_state" class="w-1/2 mb-2 border rounded px-3 py-2" placeholder="State">
      </div>

      <div class="flex gap-3">
        <input type="text" name="postal_code" id="edit_postal_code" class="w-1/2 mb-2 border rounded px-3 py-2" placeholder="Postal Code">
        <input type="text" name="country" id="edit_country" class="w-1/2 mb-2 border rounded px-3 py-2" placeholder="Country">
      </div>

      <input type="text" name="phone" id="edit_phone" class="w-full mb-4 border rounded px-3 py-2" placeholder="Phone Number">
      
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditAddressModal()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h3 class="text-xl font-semibold mb-4">Delete Address?</h3>
    <p class="mb-4">Are you sure you want to delete this address? This action cannot be undone.</p>
    <form id="delete-form" 
      method="POST" 
      hx-post="{% url 'shop:delete_address' %}" 
      hx-target="#address-tab-wrapper" 
      hx-swap="outerHTML"
      hx-on::after-request="closeDeleteModal()">
      {% csrf_token %}
      <input type="hidden" name="delete_address_id" id="delete_address_id">
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeDeleteModal()" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Delete</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
