{% extends 'linetrendy/base.html' %}
{% block content %}
<section class="bg-gray-100 min-h-screen p-4 sm:p-10">
  <div class="container mx-auto px-2 sm:px-4">
    <h1 class="text-3xl sm:text-4xl font-bold text-red-600 mb-8 text-center">Checkout</h1>

    <form method="POST" id="payment-form" class="flex flex-col lg:flex-row gap-8">
      {% csrf_token %}
      <!-- Payment Form -->
      <div class="w-full lg:w-2/3 bg-white shadow-md rounded-lg p-6 space-y-6">
        <h2 class="text-xl font-semibold text-gray-800 border-b pb-4">Payment Details</h2>

        <!-- Name on Card -->
        <div>
          <label>Name on Card</label>
          <input id="cardholder-name" type="text" placeholder="John Doe" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <!-- Stripe Card Element -->
        <div>
          <label>Card Information</label>
          <div id="card-element" class="w-full px-4 py-2 border rounded-lg"></div>
          <div id="card-errors" class="text-red-600 text-sm mt-2"></div>
        </div>

        <hr>

        <!-- Shipping Address -->
        <div class="space-y-4">
          <h3 class="font-semibold">Shipping Address</h3>

          {% if saved_addresses %}
            <label for="shipping_address">Choose an existing address:</label>
            <select name="shipping_address" id="shipping_address" class="w-full px-4 py-2 border rounded-lg">
              <option value="">-- Add a new address --</option>
              {% for address in saved_addresses %}
                <option value="{{ address.id }}">
                  {{ address.full_name }}, {{ address.line1 }}, {{ address.city }}
                </option>
              {% endfor %}
            </select>
          {% endif %}

          <!-- New Address Fields (only if adding new) -->
          <div id="new-address-fields" class="space-y-4 mt-4">
            <input name="full_name" type="text" placeholder="Full Name" 
                  class="w-full px-4 py-2 border rounded-lg">

            <input name="line1" type="text" placeholder="Street Address" 
                  class="w-full px-4 py-2 border rounded-lg">

            <input name="line2" type="text" placeholder="Apartment / Suite (Optional)" 
                  class="w-full px-4 py-2 border rounded-lg">

            <div class="flex gap-4">
              <input name="city" type="text" placeholder="City" 
                    class="w-1/2 px-4 py-2 border rounded-lg">
              <input name="state" type="text" placeholder="State / Province" 
                    class="w-1/2 px-4 py-2 border rounded-lg">
            </div>

            <div class="flex gap-4">
              <input name="postal_code" type="text" placeholder="ZIP / Postal Code" 
                    class="w-1/2 px-4 py-2 border rounded-lg">
              <select name="country" 
                      class="w-1/2 px-4 py-2 border rounded-lg">
                <option value="US" selected>United States</option>
                <option value="CA">Canada</option>
                <option value="GB">United Kingdom</option>
                <option value="AU">Australia</option>
              </select>
            </div>
          </div>

        </div>

        <div class="pt-4">
          <button id="pay-button" class="w-full bg-red-600 text-white py-3 rounded-lg">Pay Now</button>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="w-full lg:w-1/3 bg-white shadow-md rounded-lg p-6">
        <h2>Order Summary</h2>
        <div class="mt-4 space-y-3">
          {% for item in cart_items %}
          <div class="flex justify-between">
            <span>{{ item.product.name }} Ã— {{ item.quantity }}</span>
            <span>${{ item.product.price|floatformat:2 }}</span>
          </div>
          {% endfor %}
          <div class="flex justify-between font-medium border-t pt-2">
            <span>Subtotal</span><span>${{ subtotal|floatformat:2 }}</span>
          </div>
          <div class="flex justify-between">
            <span>Shipping</span><span>${{ shipping_fee|floatformat:2 }}</span>
          </div>
          {% if discount %}
          <div class="flex justify-between text-green-600">
            <span>Discount</span><span>- ${{ discount|floatformat:2 }}</span>
          </div>
          {% endif %}
          <div class="flex justify-between font-bold border-t pt-2">
            <span>Total</span><span>${{ final_total|floatformat:2 }}</span>
          </div>
        </div>
      </div>

    </form>
  </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ stripe_public_key }}");
const elements = stripe.elements();
const cardElement = elements.create("card", { hidePostalCode: true });
cardElement.mount("#card-element");

const payButton = document.getElementById("pay-button");
payButton.addEventListener("click", async (e) => {
    e.preventDefault();
    console.log("Pay button clicked.");

    try {
        const { error, paymentIntent } = await stripe.confirmCardPayment(
            "{{ client_secret }}", {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById("cardholder-name").value,
                    }
                }
            }
        );

        if (error) {
            document.getElementById("card-errors").textContent = error.message;
            return;
        }

        if (paymentIntent && paymentIntent.status === "succeeded") {
            console.log("Payment succeeded:", paymentIntent.id);

            // Submit form to server with shipping + payment info
            document.getElementById("payment-form").submit();
        }
    } catch (err) {
        document.getElementById("card-errors").textContent = "Unexpected error. Check console.";
    }
});

// Toggle new address fields visibility
document.getElementById("shipping_address")?.addEventListener("change", function () {
  const newAddressFields = document.getElementById("new-address-fields");
  if (this.value) {
    newAddressFields.style.display = "none";
  } else {
    newAddressFields.style.display = "block";
  }
});
</script>
{% endblock %}
