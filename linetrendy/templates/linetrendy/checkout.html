{% extends 'linetrendy/base.html' %}
{% block content %}
<section class="bg-gray-100 min-h-screen p-4 sm:p-10">
  <div class="container mx-auto px-2 sm:px-4">
    <h1 class="text-3xl sm:text-4xl font-bold text-red-600 mb-8 text-center">Checkout</h1>

    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Payment Form -->
      <div class="w-full lg:w-2/3 bg-white shadow-md rounded-lg p-6 space-y-6">
        <h2 class="text-xl font-semibold text-gray-800 border-b pb-4">Payment Details</h2>

        <!-- Name on Card -->
        <div>
          <label>Name on Card</label>
          <input id="cardholder-name" type="text" placeholder="John Doe" class="w-full px-4 py-2 border rounded-lg">
        </div>

        <!-- Stripe Card Element -->
        <div>
          <label>Card Information</label>
          <div id="card-element" class="w-full px-4 py-2 border rounded-lg"></div>
          <div id="card-errors" class="text-red-600 text-sm mt-2"></div>
        </div>

        <hr>

        <!-- Billing Address -->
        <div class="space-y-4">
          <h3>Billing Address</h3>
          <input id="billing-line1" type="text" placeholder="Street Address" class="w-full px-4 py-2 border rounded-lg">
          <input id="billing-line2" type="text" placeholder="Apartment / Suite (Optional)" class="w-full px-4 py-2 border rounded-lg">
          <div class="flex gap-4">
            <input id="billing-city" type="text" placeholder="City" class="w-1/2 px-4 py-2 border rounded-lg">
            <input id="billing-state" type="text" placeholder="State / Province" class="w-1/2 px-4 py-2 border rounded-lg">
          </div>
          <div class="flex gap-4">
            <input id="billing-zip" type="text" placeholder="ZIP / Postal Code" class="w-1/2 px-4 py-2 border rounded-lg">
            <select id="billing-country" class="w-1/2 px-4 py-2 border rounded-lg">
              <option value="US" selected>United States</option>
              <option value="CA">Canada</option>
              <option value="GB">United Kingdom</option>
              <option value="AU">Australia</option>
            </select>
          </div>
        </div>

        <div class="pt-4">
          <button id="pay-button" class="w-full bg-red-600 text-white py-3 rounded-lg">Pay Now</button>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="w-full lg:w-1/3 bg-white shadow-md rounded-lg p-6">
        <h2>Order Summary</h2>
        <div class="mt-4 space-y-3">
          {% for item in cart_items %}
          <div class="flex justify-between">
            <span>{{ item.product.name }} Ã— {{ item.quantity }}</span>
            <span>${{ item.product.price|floatformat:2 }}</span>
          </div>
          {% endfor %}
          <div class="flex justify-between font-medium border-t pt-2">
            <span>Subtotal</span><span>${{ subtotal|floatformat:2 }}</span>
          </div>
          <div class="flex justify-between">
            <span>Shipping</span><span>${{ shipping_fee|floatformat:2 }}</span>
          </div>
          {% if discount %}
          <div class="flex justify-between text-green-600">
            <span>Discount</span><span>- ${{ discount|floatformat:2 }}</span>
          </div>
          {% endif %}
          <div class="flex justify-between font-bold border-t pt-2">
            <span>Total</span><span>${{ final_total|floatformat:2 }}</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ stripe_public_key }}");
console.log("Stripe initialized with public key:", "{{ stripe_public_key }}");

const elements = stripe.elements();
const cardElement = elements.create("card", { hidePostalCode: true });
cardElement.mount("#card-element");

const payButton = document.getElementById("pay-button");

payButton.addEventListener("click", async (e) => {
    e.preventDefault();
    console.log("Pay button clicked.");

    const billingCountry = document.getElementById("billing-country").value;
    if (!billingCountry) {
        alert("Please select a country");
        return;
    }

    try {
        // Confirm the card payment with Stripe
        const { error, paymentIntent } = await stripe.confirmCardPayment(
            "{{ client_secret }}", {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById("cardholder-name").value,
                        address: {
                            line1: document.getElementById("billing-line1").value,
                            line2: document.getElementById("billing-line2").value,
                            city: document.getElementById("billing-city").value,
                            state: document.getElementById("billing-state").value,
                            postal_code: document.getElementById("billing-zip").value,
                            country: billingCountry,
                        }
                    }
                }
            }
        );

        if (error) {
            console.error("Stripe Payment Error:", error);
            document.getElementById("card-errors").textContent = error.message;
            return;
        }

        if (paymentIntent && paymentIntent.status === "succeeded") {
            console.log("Payment succeeded:", paymentIntent.id);

            // Send PaymentIntent ID to Django to create Order & OrderItems
            const response = await fetch("{% url 'shop:store_payment_intent' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ payment_intent_id: paymentIntent.id })
            });

            if (!response.ok) {
                console.error("Error storing payment intent in Django:", await response.text());
                alert("Payment succeeded but failed to record order. Contact support.");
                return;
            }

            // Redirect to success page
            window.location.href = "{% url 'shop:checkout_success' %}";
        } else {
            console.warn("Unexpected PaymentIntent status:", paymentIntent);
        }
    } catch (err) {
        console.error("JS Exception during payment:", err);
        document.getElementById("card-errors").textContent = "Unexpected error. Check console.";
    }
});
</script>
{% endblock %}






